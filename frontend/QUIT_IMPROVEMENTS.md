# 退出功能改进说明

## 问题描述

用户要求：右击 Lavis 的胶囊模式（菜单栏图标），然后点击退出后，真的关闭 Lavis 的所有相关进程。

## 改进内容

### 1. 增强 `stopBackend()` 函数 (`backend-manager.ts`)

#### 改进点：
- **更快的强制关闭**：将优雅关闭超时时间从 10 秒缩短到 5 秒，更快进入强制关闭阶段
- **进程树清理**：新增 `killProcessTree()` 函数，确保所有子进程都被关闭
- **macOS 特定清理**：新增 `killLavisJavaProcesses()` 函数，在 macOS 上使用系统命令查找并强制关闭所有包含 `lavis.jar` 的 Java 进程
- **更详细的日志**：添加进程 ID 和更详细的关闭日志

#### 实现细节：
```typescript
// 1. 尝试优雅关闭（5秒超时）
// 2. 如果超时，强制 SIGKILL
// 3. 使用 pkill 杀死所有子进程
// 4. 在 macOS 上，使用 ps + grep + kill 强制关闭所有相关 Java 进程
```

### 2. 改进 `will-quit` 事件处理 (`main.ts`)

#### 改进点：
- **更详细的清理日志**：每个清理步骤都有日志输出
- **错误处理**：即使某个清理步骤失败，也会继续执行其他清理步骤
- **额外等待时间**：在退出前等待 500ms，确保所有进程都已关闭
- **完整的资源清理**：
  - 取消全局快捷键
  - 停止置顶定时器
  - 销毁系统托盘
  - 关闭所有窗口
  - 停止后端服务

### 3. 系统级进程清理

#### macOS 特定优化：
- 使用 `pkill -P <pid>` 杀死进程树
- 使用 `ps aux | grep lavis.jar | kill -9` 强制关闭所有相关 Java 进程

这确保了即使进程变成僵尸进程或无法响应信号，也能被强制关闭。

## 退出流程

1. **用户点击退出** → 触发 `app.quit()`
2. **before-quit 事件** → 标记 `isQuitting = true`
3. **will-quit 事件** → 执行完整清理：
   - 取消全局快捷键
   - 停止置顶定时器
   - 销毁系统托盘
   - 关闭所有窗口
   - **停止后端服务**（关键步骤）：
     - 发送优雅关闭请求
     - 等待 5 秒
     - 强制 SIGKILL
     - 杀死进程树
     - macOS: 强制关闭所有相关 Java 进程
   - 等待 500ms
4. **app.exit(0)** → 完全退出应用

## 测试建议

1. **正常退出测试**：
   - 启动应用
   - 右击菜单栏图标
   - 点击 "Quit"
   - 检查所有进程是否已关闭：`ps aux | grep -i lavis`

2. **强制退出测试**：
   - 启动应用
   - 模拟后端无响应（可选）
   - 点击退出
   - 验证进程是否在 5-6 秒内被强制关闭

3. **进程检查命令**：
   ```bash
   # 检查是否还有 Lavis 相关进程
   ps aux | grep -i lavis
   ps aux | grep -i "lavis.jar"
   
   # 检查 Java 进程
   ps aux | grep java
   ```

## 技术细节

### 进程关闭策略

1. **优雅关闭**（首选）：
   - 发送 HTTP POST 到 `/actuator/shutdown`
   - 发送 SIGTERM 信号
   - 等待进程自然退出

2. **强制关闭**（备用）：
   - 发送 SIGKILL 信号
   - 使用系统命令杀死进程树
   - macOS: 使用 grep + kill 强制关闭所有相关进程

### 超时设置

- 优雅关闭超时：5 秒
- 强制关闭等待：500ms
- 总退出时间：约 5.5 秒（最坏情况）

## 兼容性

- ✅ macOS (darwin)
- ✅ Linux
- ✅ Windows (使用 taskkill)

## 注意事项

1. **权限**：在某些系统上，强制杀死进程可能需要适当的权限
2. **日志**：所有清理步骤都有日志输出，便于调试
3. **错误处理**：即使某个步骤失败，也会继续执行其他清理步骤，确保应用能够退出

---

*最后更新: 2025-02-05*

