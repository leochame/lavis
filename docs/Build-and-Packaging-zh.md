# Lavis æ„å»ºä¸æ‰“åŒ…æŒ‡å—

æœ¬æŒ‡å—åŒ…å«æ„å»ºã€æ‰“åŒ…ã€è°ƒè¯•å’Œæ•…éšœæ’é™¤çš„å®Œæ•´ä¿¡æ¯ã€‚

> **æ³¨æ„**ï¼šæœ¬æŒ‡å—æ¶µç›–**é»˜è®¤ JAR æ‰“åŒ…æ–¹å¼**ï¼ˆæ¨èå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ï¼‰å’Œ **GraalVM Native Image**ï¼ˆé«˜çº§é€‰é¡¹ï¼Œç”¨äº AOT ç¼–è¯‘å’Œæ›´å¼ºçš„ä»£ç ä¿æŠ¤ï¼‰ã€‚

---

## 1. ç¯å¢ƒå‡†å¤‡

### 1.1 å¿…å¤‡å·¥å…·

1. **Java å¼€å‘ç¯å¢ƒ**
   - JDK 21 æˆ–æ›´é«˜ç‰ˆæœ¬
   - Maven 3.9+ï¼ˆé¡¹ç›®å·²åŒ…å« `mvnw`ï¼Œæ— éœ€å•ç‹¬å®‰è£…ï¼›å¦‚éœ€æŒ‡å®š Mavenï¼Œå¯è®¾ç½® `MAVEN_CMD`ï¼‰

2. **Node.js ç¯å¢ƒ**
   - Node.js 18+
   - npmï¼ˆéš Node.js å®‰è£…ï¼‰
   - pnpm / yarnï¼ˆå¯é€‰æ›¿ä»£æ–¹æ¡ˆï¼‰

3. **macOS å¼€å‘ç¯å¢ƒ**
   - macOS 10.15+ï¼ˆç”¨äºæ„å»º macOS åº”ç”¨ï¼‰

### 1.2 GraalVM å®‰è£…ï¼ˆå¯é€‰ï¼Œç”¨äº Native Imageï¼‰

> **æ³¨æ„**ï¼šGraalVM ä»…åœ¨éœ€è¦ä½¿ç”¨ Native Image è¿›è¡Œ AOT ç¼–è¯‘æ—¶æ‰éœ€è¦ã€‚å¯¹äºé»˜è®¤çš„ JAR æ‰“åŒ…æ–¹å¼ï¼Œæ™®é€š JDK 21 å³å¯ã€‚

- ä» GraalVM å®˜æ–¹æˆ– SDKMAN å®‰è£… `GraalVM for JDK 21`ï¼š
  - ä½¿ç”¨ SDKMAN: `sdk install java 21-graal`
  - æˆ–è€…ä»å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…å¹¶é…ç½® `JAVA_HOME` ä¸º GraalVMã€‚
- ç¡®è®¤ `native-image` å·¥å…·å¯ç”¨ï¼š

```bash
native-image --version
```

---

## 2. å¼€å‘æ¨¡å¼

### 2.1 åç«¯å¼€å‘

**æœ¬åœ°å¼€å‘ï¼š**
```bash
./mvnw spring-boot:run
```

- é»˜è®¤ç«¯å£ï¼š`18765`
- ä¿®æ”¹ç«¯å£ï¼šåœ¨ `application.properties` ä¸­è®¾ç½® `server.port` æˆ–åœ¨å‘½ä»¤è¡Œæ·»åŠ å‚æ•°ã€‚

**æ„å»º JAR ç”¨äºæµ‹è¯•ï¼š**
```bash
./mvnw clean package
```

ç”Ÿæˆç‰©ï¼š`target/lavis-0.0.1-SNAPSHOT.jar`ï¼ˆæ–‡ä»¶åä»¥å®é™…ç‰ˆæœ¬ä¸ºå‡†ï¼‰ï¼Œé€šè¿‡ï¼š

```bash
java -jar target/lavis-0.0.1-SNAPSHOT.jar
```

å³å¯è¿è¡Œã€‚

### 2.2 å‰ç«¯å¼€å‘

```bash
cd frontend
npm install

# å¯åŠ¨ Vite å¼€å‘æœåŠ¡å™¨
npm run dev

# å¯åŠ¨ Electronï¼ˆæ¨èï¼Œå¸¦çƒ­é‡è½½ï¼‰
npm run electron:dev
```

---

## 3. æ‰“åŒ…æµç¨‹

### 3.1 é»˜è®¤æ–¹å¼ï¼ˆæ¨èï¼‰ï¼šJAR æ‰“åŒ…

é¡¹ç›®é»˜è®¤ä½¿ç”¨ JAR æ–‡ä»¶æ‰“åŒ…åç«¯ï¼Œè¿™æ˜¯æœ€ç®€å•ã€æœ€ç¨³å®šçš„æ–¹å¼ã€‚

**ä¸€é”®æ‰“åŒ…ï¼š**
```bash
cd frontend
npm install  # é¦–æ¬¡è¿è¡Œéœ€è¦å®‰è£…ä¾èµ–
npm run package
```

è¿™ä¸ªå‘½ä»¤ä¼šè‡ªåŠ¨ï¼š
1. æ£€æŸ¥å‰ç½®æ¡ä»¶ï¼ˆJavaã€Mavenã€Node.jsï¼‰
2. æ„å»º Java åç«¯ JAR æ–‡ä»¶
3. æ„å»ºå‰ç«¯ä»£ç 
4. ç¼–è¯‘ Electron ä¸»è¿›ç¨‹ä»£ç 
5. ä½¿ç”¨ electron-builder æ‰“åŒ…åº”ç”¨

### 3.2 æ‰“åŒ…è¾“å‡º

æ‰“åŒ…å®Œæˆåï¼Œåº”ç”¨æ–‡ä»¶ä½äº `frontend/dist-electron/` ç›®å½•ï¼š

```
dist-electron/
â”œâ”€â”€ Lavis-1.0.0-arm64.dmg              # macOS å®‰è£…åŒ…ï¼ˆæ¨èåˆ†å‘ï¼‰
â”œâ”€â”€ Lavis-1.0.0-arm64.dmg.blockmap      # DMG å¢é‡æ›´æ–°æ˜ å°„
â”œâ”€â”€ Lavis-1.0.0-arm64-mac.zip           # å‹ç¼©åŒ…ï¼ˆå¤‡ç”¨åˆ†å‘ï¼‰
â”œâ”€â”€ Lavis-1.0.0-arm64-mac.zip.blockmap  # ZIP å¢é‡æ›´æ–°æ˜ å°„
â””â”€â”€ mac-arm64/
    â””â”€â”€ Lavis.app/                       # macOS åº”ç”¨ç¨‹åºåŒ…
        â””â”€â”€ Contents/
            â”œâ”€â”€ Info.plist               # åº”ç”¨å…ƒæ•°æ®
            â”œâ”€â”€ MacOS/
            â”‚   â””â”€â”€ Lavis                # Electron ä¸»ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶
            â”œâ”€â”€ Frameworks/              # Electron æ¡†æ¶å’Œä¾èµ–
            â””â”€â”€ Resources/               # åº”ç”¨èµ„æº
                â”œâ”€â”€ app.asar             # å‰ç«¯ä»£ç ï¼ˆæ‰“åŒ…ï¼‰
                â”œâ”€â”€ app.asar.unpacked/   # ä» asar ä¸­è§£å‹çš„æ–‡ä»¶
                â”‚   â””â”€â”€ dist/models/     # Vosk æ¨¡å‹æ–‡ä»¶
                â”œâ”€â”€ backend/
                â”‚   â””â”€â”€ lavis.jar        # Java åç«¯ JAR æ–‡ä»¶
                â””â”€â”€ jre/                 # å†…åµŒ Java è¿è¡Œæ—¶
                    â””â”€â”€ mac-arm64/
                        â””â”€â”€ Contents/Home/bin/java
```

### 3.3 macOS Gatekeeper å¤„ç†

**æ‰“åŒ…æ—¶è‡ªåŠ¨å¤„ç†**ï¼š
- âœ… **è‡ªåŠ¨ç§»é™¤ Quarantine å±æ€§**ï¼šæ‰“åŒ…å®Œæˆåï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ç§»é™¤æœ¬åœ°æ–‡ä»¶çš„ `com.apple.quarantine` æ‰©å±•å±æ€§
- âœ… **æ— éœ€å¼€å‘è€…è¯ä¹¦**ï¼šåº”ç”¨ä½¿ç”¨ adhoc ç­¾åï¼ˆä¸´æ—¶ç­¾åï¼‰ï¼Œé€‚åˆå…è´¹åˆ†å‘
- âœ… **åŒ…å«ç”¨æˆ·å®‰è£…å·¥å…·**ï¼šDMG ä¸­è‡ªåŠ¨åŒ…å« `è‡ªåŠ¨å®‰è£….command` è„šæœ¬å’Œ `å®‰è£…è¯´æ˜.rtf` æ–‡ä»¶

**ç”¨æˆ·ä¸‹è½½å**ï¼š
ç”±äº macOS å®‰å…¨æœºåˆ¶ï¼Œä»ç½‘ç»œä¸‹è½½çš„æ–‡ä»¶ä¼šè¢«é‡æ–°æ ‡è®° quarantine å±æ€§ã€‚DMG ä¸­å·²åŒ…å«ä»¥ä¸‹å·¥å…·å¸®åŠ©ç”¨æˆ·ï¼š

1. **è‡ªåŠ¨å®‰è£…è„šæœ¬**ï¼ˆ`è‡ªåŠ¨å®‰è£….command`ï¼‰ï¼š
   - ç”¨æˆ·åŒå‡»è¿è¡Œå³å¯è‡ªåŠ¨å¤„ç†æ‰€æœ‰é—®é¢˜
   - è‡ªåŠ¨ç§»é™¤ quarantine å±æ€§
   - å¯é€‰æ‹©å®‰è£…åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹

2. **å®‰è£…è¯´æ˜**ï¼ˆ`å®‰è£…è¯´æ˜.rtf`ï¼‰ï¼š
   - è¯¦ç»†è¯´æ˜é—®é¢˜å’Œè§£å†³æ–¹æ³•
   - æä¾›å¤šç§è§£å†³æ–¹æ¡ˆ

**å¦‚æœç”¨æˆ·é‡åˆ° "åº”ç”¨å·²æŸå" é”™è¯¯**ï¼š

1. **æ¨èæ–¹æ³•**ï¼šä½¿ç”¨ DMG ä¸­çš„ `è‡ªåŠ¨å®‰è£….command` è„šæœ¬
2. **å¤‡é€‰æ–¹æ³•**ï¼šå³é”®ç‚¹å‡»åº”ç”¨ï¼Œé€‰æ‹©"æ‰“å¼€"ï¼Œç„¶ååœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ç‚¹å‡»"æ‰“å¼€"
3. **æ‰‹åŠ¨æ–¹æ³•**ï¼š
   ```bash
   xattr -dr com.apple.quarantine /path/to/Lavis.app
   ```

> **æ³¨æ„**ï¼šå¦‚æœéœ€è¦æ­£å¼åˆ†å‘ä¸”å¸Œæœ›ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œå³å¯è¿è¡Œï¼ˆå¦‚é€šè¿‡ App Storeï¼‰ï¼Œå»ºè®®è·å– Apple Developer è¯ä¹¦å¹¶é…ç½®ä»£ç ç­¾åå’Œå…¬è¯ã€‚è¯¦è§ [8.2 ä»£ç ç­¾å](#82-ä»£ç ç­¾å) å’Œ [8.3 å…¬è¯](#83-å…¬è¯)ã€‚

---

## 4. é«˜çº§é€‰é¡¹ï¼šGraalVM Native Image

> **æ³¨æ„**ï¼šè¿™æ˜¯å¯é€‰çš„é«˜çº§é€‰é¡¹ã€‚é¡¹ç›®é»˜è®¤ä½¿ç”¨ JAR æ–‡ä»¶æ‰“åŒ…ã€‚  
> ä»…åœ¨éœ€è¦ AOT ç¼–è¯‘ã€æ›´å¼ºçš„ä»£ç ä¿æŠ¤æˆ–ç‰¹å®šæ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ GraalVM Native Imageã€‚

### 4.1 æ¦‚å¿µä¸ä¼˜åŠ¿

- **AOT ç¼–è¯‘**ï¼šGraalVM å°† Spring Boot + ä¸šåŠ¡ä»£ç åœ¨æ„å»ºé˜¶æ®µç¼–è¯‘ä¸ºå¹³å°åŸç”Ÿæœºå™¨ç ã€‚
- **æ— å­—èŠ‚ç **ï¼šæœ€ç»ˆäº§ç‰©ä¸åŒ…å« `.class` æ–‡ä»¶ï¼Œä¼ ç»Ÿ Java åç¼–è¯‘å·¥å…·ï¼ˆJD-GUIã€CFRï¼‰æ— æ³•è¿˜åŸæºç ã€‚
- **æå‡å®‰å…¨æ€§**ï¼šé€†å‘éœ€åŸºäºæ±‡ç¼–ï¼Œé…åˆç¼–è¯‘ä¼˜åŒ–ï¼ˆå†…è”ã€æ­»ä»£ç æ¶ˆé™¤ï¼‰ï¼Œæå¤§å¢åŠ ç ´è§£æˆæœ¬ã€‚

### 4.2 Maven æ’ä»¶é›†æˆ

> ä¸‹é¢æ˜¯æ¨èçš„é…ç½®ç¤ºä¾‹ï¼Œå¯æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µæ·»åŠ åˆ° `pom.xml` ä¸­ã€‚

åœ¨ `pom.xml` çš„ `<build><plugins>` éƒ¨åˆ†ä¸­å¢åŠ ï¼š

```xml
<plugin>
    <groupId>org.graalvm.buildtools</groupId>
    <artifactId>native-maven-plugin</artifactId>
    <version>0.10.2</version>
    <extensions>true</extensions>
    <configuration>
        <imageName>lavis-backend</imageName>
        <buildArgs>
            <!-- æ ¹æ®éœ€è¦å¼€å¯è°ƒè¯•/æ—¥å¿—ç­‰å‚æ•° -->
            <!-- <buildArg>--verbose</buildArg> -->
        </buildArgs>
    </configuration>
</plugin>
```

> å®é™…ç‰ˆæœ¬å·å’Œé…ç½®è¯·å‚è€ƒ GraalVM å®˜æ–¹æ–‡æ¡£ï¼Œå°¤å…¶æ˜¯ä¸ Spring Boot 3.5.9 çš„å…¼å®¹æ€§ã€‚

### 4.3 æ„å»º Native Image

```bash
./mvnw -Pnative -DskipTests native:compile
```

æ„å»ºæˆåŠŸåï¼Œå°†åœ¨ `target/` ä¸‹ç”Ÿæˆå¯æ‰§è¡ŒäºŒè¿›åˆ¶ï¼ˆå¦‚ `lavis-backend`ï¼‰ï¼Œç›´æ¥è¿è¡Œï¼š

```bash
./target/lavis-backend
```

### 4.4 åå°„ä¸èµ„æºé…ç½®

- GraalVM é‡‡ç”¨ã€Œå°é—­ä¸–ç•Œã€å‡è®¾ï¼Œé»˜è®¤åªä¿ç•™è¢«é™æ€åˆ†æåˆ°çš„ä»£ç è·¯å¾„ã€‚
- å¦‚æœé¡¹ç›®ä½¿ç”¨åå°„ï¼ˆå¦‚ä¸€äº› Spring æˆ– LangChain4j åŠŸèƒ½ï¼‰ï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„åå°„é…ç½®æ–‡ä»¶æˆ–ä½¿ç”¨å®˜æ–¹ Spring Native æ”¯æŒã€‚

### 4.5 åœ¨ Electron ä¸­ä½¿ç”¨ Native Image

å¦‚æœéœ€è¦ä½¿ç”¨ GraalVM Native Image æ‰“åŒ…åç«¯ï¼š

1. ä½¿ç”¨ GraalVM å°†åç«¯æ‰“åŒ…ä¸º Native Imageï¼Œå¯æ‰§è¡Œæ–‡ä»¶å¦‚ `lavis-backend`ã€‚
2. åœ¨ macOS ä¸Šæµ‹è¯•è¯¥äºŒè¿›åˆ¶ï¼Œç¡®ä¿æ‰€æœ‰ API æ­£å¸¸å·¥ä½œã€‚
3. åœ¨ Electron ä¸»è¿›ç¨‹ä¸­ï¼š
   - å¯åŠ¨åº”ç”¨æ—¶ï¼Œæ£€æµ‹/å¯åŠ¨åç«¯äºŒè¿›åˆ¶è¿›ç¨‹ï¼ˆå¯é€‰ï¼šåµŒå…¥æˆ–æ—æŒ‚ï¼‰ã€‚
   - ç›‘å¬åº”ç”¨é€€å‡ºäº‹ä»¶ï¼Œä¼˜é›…å…³é—­åç«¯è¿›ç¨‹ã€‚
4. ä½¿ç”¨ `npm run electron:build` æ‰“åŒ…ä¸º `.dmg` æˆ– `.app` è¿›è¡Œåˆ†å‘ã€‚

> **æ³¨æ„**ï¼šå½“å‰ä»“åº“ä¸­å°šæœªå®Œå…¨è‡ªåŠ¨åŒ–ã€ŒElectron å†…åµŒ Native Image åç«¯è¿›ç¨‹ã€çš„é€»è¾‘ï¼Œä¸Šè¿°ä¸ºæ¨èæ¶æ„æ–¹å‘ã€‚  
> å¦‚éœ€ä½¿ç”¨ Native Imageï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ Electron ä¸»è¿›ç¨‹ä»£ç ä»¥æ”¯æŒå¯åŠ¨äºŒè¿›åˆ¶æ–‡ä»¶è€Œé JARã€‚

---

## 5. æ‰“åŒ…å·¥å…·å’Œæ–‡ä»¶

### æ ¸å¿ƒæ‰“åŒ…æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `frontend/scripts/package.js` | ä¸€é”®æ‰“åŒ…è„šæœ¬ï¼Œè‡ªåŠ¨åŒ–æ•´ä¸ªæ‰“åŒ…æµç¨‹ |
| `frontend/electron-builder.config.js` | electron-builder é…ç½®æ–‡ä»¶ |
| `frontend/package.json` | npm è„šæœ¬å’Œä¾èµ–é…ç½® |
| `frontend/build/entitlements.mac.plist` | macOS æƒé™é…ç½® |
| `frontend/build/icon.icns` | åº”ç”¨å›¾æ ‡æ–‡ä»¶ |

### å¼€å‘å’Œæµ‹è¯•å·¥å…·

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `frontend/scripts/test-packaged-app.sh` | æµ‹è¯•æ‰“åŒ…åçš„åº”ç”¨ï¼Œè‡ªåŠ¨æ‰“å¼€å¼€å‘è€…å·¥å…· |
| `frontend/scripts/diagnose-wake-word.sh` | è¯Šæ–­æ‰“åŒ…ååº”ç”¨çš„å”¤é†’è¯é—®é¢˜ |
| `frontend/scripts/open-devtools.sh` | æ‰“å¼€æ‰“åŒ…ååº”ç”¨çš„å¼€å‘è€…å·¥å…· |
| `frontend/scripts/generate-icon.js` | ç”Ÿæˆ macOS åº”ç”¨å›¾æ ‡ (.icns) |
| `frontend/scripts/electron-dev.js` | å¼€å‘æ¨¡å¼å¯åŠ¨ Electron åº”ç”¨ |

### ç›¸å…³æºä»£ç æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æ‰“åŒ…ç›¸å…³åŠŸèƒ½ |
|---------|------------|
| `frontend/electron/main.ts` | æ£€æµ‹æ‰“åŒ…ç¯å¢ƒï¼Œç®¡ç†åç«¯è¿›ç¨‹ |
| `frontend/electron/backend-manager.ts` | åœ¨æ‰“åŒ…ç¯å¢ƒä¸­å¯åŠ¨å†…åµŒ JRE å’Œ JAR |
| `frontend/electron/preload.ts` | æä¾›å®‰å…¨çš„ API æ¡¥æ¥ |
| `frontend/vite.config.ts` | æ„å»ºå‰ç«¯èµ„æº |

---

## 6. å·¥ä½œåŸç†

1. **è‡ªåŠ¨å¯åŠ¨åç«¯**ï¼šåº”ç”¨å¯åŠ¨æ—¶ï¼ŒElectron ä¸»è¿›ç¨‹ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¯åŠ¨å†…åµŒçš„ Java åç«¯
2. **JRE ç®¡ç†**ï¼šä½¿ç”¨å†…åµŒçš„ JRE è¿è¡Œ Java åç«¯ï¼Œæ— éœ€ç”¨æˆ·å®‰è£… Java
3. **èµ„æºç®¡ç†**ï¼šJAR å’Œ JRE é€šè¿‡ `extraResources` æ‰“åŒ…åˆ°åº”ç”¨çš„ Resources ç›®å½•
4. **è¿›ç¨‹ç®¡ç†**ï¼šåº”ç”¨é€€å‡ºæ—¶è‡ªåŠ¨å…³é—­ Java åç«¯è¿›ç¨‹

### å¼€å‘æ¨¡å¼ vs ç”Ÿäº§æ¨¡å¼

**å¼€å‘æ¨¡å¼**ï¼š
- ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ Java
- JAR ä»é¡¹ç›® `target/` ç›®å½•åŠ è½½
- å‰ç«¯ä» Vite å¼€å‘æœåŠ¡å™¨åŠ è½½

**ç”Ÿäº§æ¨¡å¼ï¼ˆæ‰“åŒ…åï¼‰**ï¼š
- ä½¿ç”¨å†…åµŒçš„ JRE
- JAR ä»åº”ç”¨ Resources ç›®å½•åŠ è½½
- å‰ç«¯ä»æ‰“åŒ…çš„ `app.asar` åŠ è½½

---

## 7. è°ƒè¯•ä¸æ•…éšœæ’é™¤

### 7.1 æ‰“å¼€å¼€å‘è€…å·¥å…·

#### æ–¹æ³• 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨é»˜è®¤è·¯å¾„
./frontend/scripts/test-packaged-app.sh

# æˆ–æŒ‡å®šåº”ç”¨è·¯å¾„
./frontend/scripts/test-packaged-app.sh /path/to/Lavis.app
```

#### æ–¹æ³• 2: ä½¿ç”¨è¯Šæ–­è„šæœ¬

```bash
# è¯Šæ–­åº”ç”¨ç»“æ„å’Œæ¨¡å‹æ–‡ä»¶
./frontend/scripts/diagnose-wake-word.sh
```

#### æ–¹æ³• 3: æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡

```bash
export ELECTRON_DEVTOOLS=1
export OPEN_DEVTOOLS=1
open -a frontend/dist-electron/mac-arm64/Lavis.app
```

#### æ–¹æ³• 4: å¿«æ·é”®

åœ¨åº”ç”¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨å¿«æ·é”®ï¼š
- **macOS**: `Cmd+Alt+I`
- **Windows/Linux**: `Ctrl+Alt+I`

### 7.2 æŸ¥çœ‹æ—¥å¿—

åœ¨å¼€å‘è€…å·¥å…·çš„ **Console** æ ‡ç­¾ä¸­ï¼ŒæŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š

- `[Vosk] Loading model from: ...` - æ¨¡å‹åŠ è½½å¼€å§‹
- `[Vosk] âœ… Model loaded successfully` - æ¨¡å‹åŠ è½½æˆåŠŸ
- `[Vosk] ğŸ¤ Recognized: "..."` - è¯†åˆ«åˆ°çš„æ–‡æœ¬
- `[Vosk] âœ… Wake word matched!` - å”¤é†’è¯åŒ¹é…æˆåŠŸ

### 7.3 åç«¯è°ƒè¯•

**ä½¿ç”¨æ™®é€š JAR è¿è¡Œæ—¶ï¼š**
```bash
./mvnw spring-boot:run
```

**ä½¿ç”¨ Native Image æ—¶ï¼Œè‹¥å¯åŠ¨å¤±è´¥ï¼š**
- åŠ ä¸Š `--verbose` æ„å»ºå‚æ•°é‡æ–°æ„å»ºï¼›
- æ£€æŸ¥ç¼ºå¤±çš„åå°„é…ç½®æˆ–èµ„æºæ–‡ä»¶ã€‚

**åç«¯è¿æ¥æ£€æŸ¥ï¼š**
- ä½¿ç”¨ `curl http://localhost:18765/api/agent/status` æ£€æŸ¥åç«¯ã€‚

### 7.4 å‰ç«¯è°ƒè¯•

**Electron çª—å£ç©ºç™½ï¼š**
- æ‰“å¼€ DevToolsï¼ˆ`Cmd+Option+I`ï¼‰æŸ¥çœ‹æŠ¥é”™ï¼›
- ç¡®è®¤ Vite å¼€å‘æœåŠ¡å™¨æˆ–æ‰“åŒ…èµ„æºæ˜¯å¦æ­£å¸¸ã€‚

### 7.5 å¸¸è§é—®é¢˜

#### 1. æ‰“åŒ…å¤±è´¥ï¼šJAR æ–‡ä»¶æœªæ‰¾åˆ°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
JAR file not found at: ...
```

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®ä¿å·²è¿è¡Œ `mvn clean package` æ„å»ºåç«¯
- æ£€æŸ¥ `target/lavis-0.0.1-SNAPSHOT.jar` æ˜¯å¦å­˜åœ¨

#### 2. æ‰“åŒ…å¤±è´¥ï¼šMaven æœªæ‰¾åˆ°

**è§£å†³æ–¹æ³•**ï¼š
- è„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿ Maven æˆ–é¡¹ç›®è‡ªå¸¦ `mvnw`
- å¦‚éœ€æŒ‡å®š Maven è·¯å¾„ï¼Œä½¿ç”¨ï¼š`MAVEN_CMD=/path/to/mvn npm run package`
- ç¡®è®¤å·²å®‰è£… JDK å¹¶ä¸” `java -version` å¯ç”¨
- å¦‚æç¤º `JAVA_HOME` æœªè®¾ç½®ï¼Œå¯å…ˆæ‰§è¡Œï¼š`export JAVA_HOME=$(/usr/libexec/java_home)`

#### 3. JRE æœªæ‰¾åˆ°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Java executable not found at: ...
```

**è§£å†³æ–¹æ³•**ï¼š
- ç¡®ä¿ `frontend/jre/mac-arm64/` ç›®å½•å­˜åœ¨
- æ£€æŸ¥ JRE ç›®å½•ç»“æ„æ˜¯å¦æ­£ç¡®

#### 4. æ‰“åŒ…å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- ç¼ºå°‘ä¾èµ–ï¼šè¿è¡Œ `npm install` å®‰è£…ä¾èµ–
- electron-builder æœªå®‰è£…ï¼šè¿è¡Œ `npm install -D electron-builder`
- æƒé™é—®é¢˜ï¼šç¡®ä¿æœ‰å†™å…¥ `dist-electron` ç›®å½•çš„æƒé™

#### 5. åº”ç”¨æ— æ³•å¯åŠ¨åç«¯

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼ˆConsole.app æˆ–ç»ˆç«¯ï¼‰
2. ç¡®è®¤ JAR å’Œ JRE è·¯å¾„æ­£ç¡®
3. æ£€æŸ¥ JRE æ˜¯å¦æœ‰æ‰§è¡Œæƒé™

#### 6. å”¤é†’è¯ä¸å·¥ä½œ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. æ¨¡å‹æ–‡ä»¶æ˜¯å¦ä» asar ä¸­è§£å‹ï¼ˆåº”åœ¨ `app.asar.unpacked/dist/models/`ï¼‰
2. ä½¿ç”¨è¯Šæ–­è„šæœ¬æ£€æŸ¥ï¼š`./frontend/scripts/diagnose-wake-word.sh`
3. æ£€æŸ¥ Console æ—¥å¿—ä¸­çš„æ¨¡å‹åŠ è½½ä¿¡æ¯

**å¸¸è§é—®é¢˜**ï¼š

- **æ¨¡å‹æ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆ404 é”™è¯¯ï¼‰**
  - æ£€æŸ¥ `frontend/public/models/` ç›®å½•æ˜¯å¦å­˜åœ¨æ¨¡å‹æ–‡ä»¶
  - ç¡®è®¤æ‰“åŒ…é…ç½®ä¸­ `asarUnpack` åŒ…å« `dist/models/**/*.tar.gz`
  - é‡æ–°æ‰“åŒ…åº”ç”¨

- **æ¨¡å‹åŠ è½½å¤±è´¥**
  - æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å®Œæ•´
  - æŸ¥çœ‹ Network æ ‡ç­¾ï¼Œç¡®è®¤æ¨¡å‹æ–‡ä»¶è¯·æ±‚çš„ URL
  - æ£€æŸ¥æ–‡ä»¶æƒé™

- **è¯†åˆ«åˆ°æ–‡æœ¬ä½†ä¸åŒ¹é…**
  - æ£€æŸ¥å”¤é†’è¯é…ç½®ï¼ˆé»˜è®¤æ˜¯ "hi lavis"ï¼‰
  - æŸ¥çœ‹è¯†åˆ«åˆ°çš„æ–‡æœ¬ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´éŸ³è¿‘è¯æ˜ å°„
  - å°è¯•æ›´æ¸…æ™°åœ°å‘éŸ³

#### 7. macOS Gatekeeper é˜»æ­¢è¿è¡Œï¼ˆ"åº”ç”¨å·²æŸå"é”™è¯¯ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
"Lavis" is damaged and can't be opened. You should move it to the Trash.
```

**é—®é¢˜åŸå› **ï¼š
1. **macOS å®‰å…¨æœºåˆ¶**ï¼šä»ç½‘ç»œä¸‹è½½çš„æ–‡ä»¶ä¼šè¢« macOS è‡ªåŠ¨æ ‡è®° `com.apple.quarantine` æ‰©å±•å±æ€§
2. **Gatekeeper é˜»æ­¢**ï¼šæœªç­¾åæˆ–æœªå…¬è¯çš„åº”ç”¨ä¼šè¢« Gatekeeper å®‰å…¨æœºåˆ¶é˜»æ­¢è¿è¡Œ
3. **ä¸‹è½½åé‡æ–°æ ‡è®°**ï¼šå³ä½¿æ‰“åŒ…æ—¶ç§»é™¤äº† quarantine å±æ€§ï¼Œç”¨æˆ·ä»ç½‘ä¸Šä¸‹è½½åï¼ŒmacOS ä¼šé‡æ–°æ·»åŠ è¯¥å±æ€§

**ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜**ï¼š
- è¿™æ˜¯ macOS çš„æ­£å¸¸å®‰å…¨è¡Œä¸ºï¼Œç”¨äºä¿æŠ¤ç”¨æˆ·å…å—æ¶æ„è½¯ä»¶ä¾µå®³
- æœªä½¿ç”¨ Apple Developer è¯ä¹¦ç­¾åçš„åº”ç”¨ï¼ˆadhoc ç­¾åï¼‰ä¼šè¢« Gatekeeper æ‹¦æˆª
- ä»æµè§ˆå™¨ä¸‹è½½çš„æ–‡ä»¶ä¼šè‡ªåŠ¨è·å¾— quarantine å±æ€§

**ç”¨æˆ·å‹å¥½çš„è§£å†³æ–¹æ¡ˆ**ï¼ˆå·²å†…ç½®åœ¨ DMG ä¸­ï¼‰ï¼š

DMG å®‰è£…åŒ…ä¸­å·²åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

1. **è‡ªåŠ¨å®‰è£…è„šæœ¬**ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰ï¼š
   - æ‰“å¼€ DMG åï¼ŒåŒå‡» `è‡ªåŠ¨å®‰è£….command` æ–‡ä»¶
   - å¦‚æœå‡ºç°å®‰å…¨æç¤ºï¼Œç‚¹å‡»"æ‰“å¼€"æˆ–"å…è®¸"
   - è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
     - ç§»é™¤ quarantine å±æ€§
     - è¯¢é—®æ˜¯å¦å®‰è£…åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
     - å¯é€‰æ‹©ç«‹å³å¯åŠ¨åº”ç”¨

2. **å®‰è£…è¯´æ˜æ–‡ä»¶**ï¼š
   - æ‰“å¼€ DMG åï¼ŒåŒå‡» `å®‰è£…è¯´æ˜.rtf` æŸ¥çœ‹è¯¦ç»†è¯´æ˜

3. **æ‰‹åŠ¨æ–¹æ³•**ï¼ˆå¦‚æœè‡ªåŠ¨è„šæœ¬ä¸å¯ç”¨ï¼‰ï¼š
   - **æ–¹æ³• A**ï¼šå³é”®ç‚¹å‡» `Lavis.app`ï¼Œé€‰æ‹©"æ‰“å¼€"ï¼Œç„¶ååœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ç‚¹å‡»"æ‰“å¼€"
   - **æ–¹æ³• B**ï¼šä½¿ç”¨ç»ˆç«¯å‘½ä»¤
     ```bash
     # å¯¹äº .app æ–‡ä»¶
     xattr -dr com.apple.quarantine /path/to/Lavis.app
     
     # å¯¹äº .dmg æ–‡ä»¶ï¼ˆå®‰è£…å‰ï¼‰
     xattr -d com.apple.quarantine /path/to/Lavis-1.0.0-arm64.dmg
     ```

**å¼€å‘è€…æ³¨æ„äº‹é¡¹**ï¼š
- æ‰“åŒ…è„šæœ¬ä¼šåœ¨æ‰“åŒ…åè‡ªåŠ¨ç§»é™¤æœ¬åœ°æ–‡ä»¶çš„ quarantine å±æ€§
- ä½†ç”¨æˆ·ä¸‹è½½åï¼ŒmacOS ä¼šé‡æ–°æ·»åŠ è¯¥å±æ€§ï¼Œè¿™æ˜¯æ­£å¸¸çš„å®‰å…¨æœºåˆ¶
- å¦‚éœ€å½»åº•è§£å†³ï¼ˆæ— éœ€ç”¨æˆ·æ“ä½œï¼‰ï¼Œéœ€è¦ï¼š
  1. è·å– Apple Developer è¯ä¹¦ï¼ˆ$99/å¹´ï¼‰
  2. é…ç½®ä»£ç ç­¾å
  3. è¿›è¡Œå…¬è¯ï¼ˆNotarizationï¼‰
- å½“å‰æ–¹æ¡ˆï¼ˆadhoc ç­¾å + è‡ªåŠ¨å®‰è£…è„šæœ¬ï¼‰æ˜¯å…è´¹ä¸”ç”¨æˆ·å‹å¥½çš„æŠ˜ä¸­æ–¹æ¡ˆ

> **æ³¨æ„**ï¼šåº”ç”¨ä½¿ç”¨ adhoc ç­¾åï¼ˆä¸´æ—¶ç­¾åï¼‰ï¼Œè¿™æ˜¯å…è´¹æ–¹æ¡ˆã€‚å¦‚éœ€æ­£å¼åˆ†å‘ä¸”å¸Œæœ›ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œå³å¯è¿è¡Œï¼Œå»ºè®®è·å– Apple Developer è¯ä¹¦å¹¶é…ç½®ä»£ç ç­¾åå’Œå…¬è¯ã€‚

---

## 8. è¿›é˜¶é…ç½®

### 8.1 è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡

1. å‡†å¤‡å›¾æ ‡æ–‡ä»¶ï¼ˆ.icns æ ¼å¼ï¼‰
2. æ”¾ç½®åˆ° `frontend/build/icon.icns`
3. electron-builder ä¼šè‡ªåŠ¨ä½¿ç”¨

æˆ–ä½¿ç”¨å·¥å…·ç”Ÿæˆï¼š

```bash
cd frontend
node scripts/generate-icon.js
```

### 8.2 ä»£ç ç­¾å

å¦‚éœ€ä»£ç ç­¾åï¼Œåœ¨ `frontend/electron-builder.config.js` ä¸­æ·»åŠ ï¼š

```javascript
mac: {
  identity: 'Developer ID Application: Your Name (TEAM_ID)',
  // ...
}
```

### 8.3 å…¬è¯ï¼ˆNotarizationï¼‰

å¦‚éœ€å…¬è¯ï¼Œé…ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
export APPLE_ID="your@email.com"
export APPLE_ID_PASSWORD="app-specific-password"
export APPLE_TEAM_ID="TEAM_ID"
```

---

## 9. ç›¸å…³èµ„æº

- [Electron Builder æ–‡æ¡£](https://www.electron.build/)
- [é¡¹ç›®æ ¹ç›®å½• README](../README.md)
- [ç³»ç»Ÿæ¶æ„](ARCHITECTURE.md)

